<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insider Trading Intelligence Platform</title>
    <link rel="stylesheet" href="/static/css/premium.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                üìä Insider Intelligence
            </div>
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-label">Total Trades</div>
                    <div class="stat-value" id="totalTrades">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Active Signals</div>
                    <div class="stat-value" id="activeSignals">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Total Volume</div>
                    <div class="stat-value" id="totalVolume">$-</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Tabs -->
        <div style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 2px solid var(--border-color);">
            <button class="tab-btn active" onclick="showTab('signals')" id="signalsTab">
                üìä Signals
            </button>
            <button class="tab-btn" onclick="showTab('query')" id="queryTab">
                üîç Query Builder
            </button>
        </div>

        <!-- Signals Tab -->
        <div id="signalsContent">
            <!-- Filters -->
        <div class="filters">
            <div class="filter-grid">
                <div class="filter-group">
                    <label class="filter-label">Risk Tolerance</label>
                    <select class="filter-select" id="riskTolerance">
                        <option value="conservative">Conservative</option>
                        <option value="moderate" selected>Moderate</option>
                        <option value="aggressive">Aggressive</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Market Cap</label>
                    <select class="filter-select" id="marketCap">
                        <option value="all" selected>All Caps</option>
                        <option value="mega">Mega Cap (>$200B)</option>
                        <option value="large">Large Cap ($10-200B)</option>
                        <option value="mid">Mid Cap ($2-10B)</option>
                        <option value="small">Small Cap ($300M-$2B)</option>
                        <option value="micro">Micro Cap (<$300M)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Min Confidence</label>
                    <select class="filter-select" id="minConfidence">
                        <option value="0">All (0%)</option>
                        <option value="50">Above 50%</option>
                        <option value="75">Above 75%</option>
                        <option value="90">Above 90%</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Results Limit</label>
                    <select class="filter-select" id="resultsLimit">
                        <option value="10">10 signals</option>
                        <option value="25">25 signals</option>
                        <option value="50" selected>50 signals</option>
                        <option value="100">100 signals</option>
                    </select>
                </div>
            </div>
            <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                <button class="btn btn-primary" onclick="loadSignals()">
                    üîÑ Refresh Signals
                </button>
                <button class="btn btn-secondary" onclick="exportToCSV()">
                    üì• Export to CSV
                </button>
            </div>
        </div>

            <!-- Signals Grid -->
            <div id="signalsContainer">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Query Builder Tab -->
        <div id="queryContent" style="display: none;">
            <div class="filters">
                <h3 style="margin: 0 0 1rem 0; color: var(--text-primary);">üîç Custom Trade Query Builder</h3>
                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label">Ticker (optional)</label>
                        <input type="text" class="filter-input" id="queryTicker" placeholder="e.g. NVDA">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Start Date</label>
                        <input type="date" class="filter-input" id="queryStartDate">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">End Date</label>
                        <input type="date" class="filter-input" id="queryEndDate">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Min Amount ($)</label>
                        <input type="number" class="filter-input" id="queryMinAmount" placeholder="e.g. 100000">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Max Amount ($)</label>
                        <input type="number" class="filter-input" id="queryMaxAmount" placeholder="e.g. 5000000">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Transaction Type</label>
                        <select class="filter-select" id="queryTxType">
                            <option value="">All Types</option>
                            <option value="BUY">Buy</option>
                            <option value="SELL">Sell</option>
                            <option value="OPTION_EXERCISE">Option Exercise</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Filer Type</label>
                        <select class="filter-select" id="queryFilerType">
                            <option value="">All Types</option>
                            <option value="POLITICIAN">Politician</option>
                            <option value="CORPORATE_INSIDER">Corporate Insider</option>
                            <option value="INSTITUTIONAL_INVESTOR">Institutional</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Results Limit</label>
                        <select class="filter-select" id="queryLimit">
                            <option value="50">50 results</option>
                            <option value="100" selected>100 results</option>
                            <option value="200">200 results</option>
                            <option value="500">500 results</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                    <button class="btn btn-primary" onclick="runCustomQuery()">
                        üîç Run Query
                    </button>
                    <button class="btn btn-secondary" onclick="exportQueryResults()">
                        üì• Export Results
                    </button>
                    <button class="btn btn-secondary" onclick="clearQueryFilters()">
                        üîÑ Clear Filters
                    </button>
                </div>
            </div>

            <!-- Query Results -->
            <div id="queryResults" style="margin-top: 2rem;">
                <div style="text-align: center; padding: 4rem 2rem; color: var(--text-secondary);">
                    Configure your filters and click "Run Query" to see results
                </div>
            </div>
        </div>
    </div>

    <!-- Signal Details Modal -->
    <div id="detailsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
         background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;
         padding: 2rem; overflow-y: auto;" onclick="if(event.target === this) closeModal()">
        <div style="background: var(--bg-secondary); border-radius: 16px; padding: 2rem; 
             max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; 
             border: 1px solid var(--border-color); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0; font-size: 1.5rem;">Signal Details</h2>
                <button onclick="closeModal()" style="background: none; border: none; color: var(--text-secondary); 
                        font-size: 2rem; cursor: pointer; padding: 0; width: 40px; height: 40px; 
                        display: flex; align-items: center; justify-content: center; border-radius: 8px; 
                        transition: all 0.2s;" onmouseover="this.style.background='var(--bg-card)'; this.style.color='var(--text-primary)'" 
                        onmouseout="this.style.background='none'; this.style.color='var(--text-secondary)'">√ó</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Insider Profile Modal -->
    <div id="insiderModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
         background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;
         padding: 2rem; overflow-y: auto;" onclick="if(event.target === this) closeInsiderModal()">
        <div style="background: var(--bg-secondary); border-radius: 16px; padding: 2rem; 
             max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; 
             border: 1px solid var(--border-color); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0; font-size: 1.5rem;">üë§ Insider Profile</h2>
                <button onclick="closeInsiderModal()" style="background: none; border: none; color: var(--text-secondary); 
                        font-size: 2rem; cursor: pointer; padding: 0; width: 40px; height: 40px; 
                        display: flex; align-items: center; justify-content: center; border-radius: 8px; 
                        transition: all 0.2s;" onmouseover="this.style.background='var(--bg-card)'; this.style.color='var(--text-primary)'" 
                        onmouseout="this.style.background='none'; this.style.color='var(--text-secondary)'">√ó</button>
            </div>
            <div id="insiderModalContent"></div>
        </div>
    </div>

    <script>
        // Global data
        let allSignals = [];

        // Format currency
        function formatCurrency(value) {
            if (!value) return '$0';
            if (value >= 1e9) return '$' + (value / 1e9).toFixed(2) + 'B';
            if (value >= 1e6) return '$' + (value / 1e6).toFixed(2) + 'M';
            if (value >= 1e3) return '$' + (value / 1e3).toFixed(2) + 'K';
            return '$' + value.toFixed(2);
        }

        // Load stats
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                document.getElementById('totalTrades').textContent = 
                    (data.total_trades || 0).toLocaleString();
                document.getElementById('totalVolume').textContent = 
                    formatCurrency(data.total_volume || 0);
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load signals
        async function loadSignals() {
            const container = document.getElementById('signalsContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const risk = document.getElementById('riskTolerance').value;
                const marketCap = document.getElementById('marketCap').value;
                const minConf = document.getElementById('minConfidence').value;
                const limit = document.getElementById('resultsLimit').value;

                const url = `/api/signals/enhanced?risk=${risk}&market_cap=${marketCap}&min_confidence=${minConf}&limit=${limit}`;
                const response = await fetch(url);
                const data = await response.json();

                allSignals = data.signals || [];
                
                // Update stats
                document.getElementById('activeSignals').textContent = allSignals.length;

                if (allSignals.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üì≠</div>
                            <div class="empty-title">No signals found</div>
                            <div class="empty-text">Try adjusting your filters or check back later</div>
                        </div>
                    `;
                    return;
                }

                // Render signals
                container.innerHTML = '<div class="signals-grid" id="signalsGrid"></div>';
                const grid = document.getElementById('signalsGrid');

                allSignals.forEach((signal, index) => {
                    const card = createSignalCard(signal, index);
                    grid.appendChild(card);
                });

            } catch (error) {
                console.error('Error loading signals:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ö†Ô∏è</div>
                        <div class="empty-title">Error loading signals</div>
                        <div class="empty-text">${error.message}</div>
                    </div>
                `;
            }
        }

        // Create signal card
        function createSignalCard(signal, index) {
            const card = document.createElement('div');
            card.className = 'signal-card';
            card.style.animationDelay = `${index * 0.05}s`;

            card.innerHTML = `
                <div class="signal-header">
                    <div class="ticker">${signal.ticker}</div>
                    <div class="strength-badge">${signal.strength.toFixed(0)}%</div>
                </div>
                
                <span class="signal-type ${signal.signal_type}">${signal.signal_type}</span>
                
                <div class="insider-info">
                    <div class="info-item">
                        <span class="info-label">Total Trades</span>
                        <span class="info-value highlight">${signal.num_trades || 0}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Unique Insiders</span>
                        <span class="info-value highlight">${signal.num_insiders || 0}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Total Volume</span>
                        <span class="info-value">${formatCurrency(signal.total_volume || 0)}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Buy Trades</span>
                        <span class="info-value">${signal.num_buys || 0}</span>
                    </div>
                </div>

                <div class="insider-list">
                    <div class="insider-list-title">üè¢ Top Insiders (hover for details, click for full profile)</div>
                    <div class="insider-tags">
                        ${signal.insiders && signal.insiders.length > 0 
                            ? signal.insiders.slice(0, 5).map(name => 
                                `<span class="insider-tag insider-hover" 
                                      data-insider="${name}" 
                                      onmouseenter="showInsiderTooltip(event, '${name.replace(/'/g, "\\'")}')"
                                      onmouseleave="hideInsiderTooltip()"
                                      onclick="showInsiderModal('${name.replace(/'/g, "\\'")}')"
                                      style="cursor: pointer;"
                                      title="Hover for quick info, click for full profile">${name.slice(0, 20)}${name.length > 20 ? '...' : ''}</span>`
                              ).join('')
                            : '<span class="insider-tag">No names available</span>'}
                    </div>
                </div>
                
                <!-- Insider Tooltip -->
                <div id="insiderTooltip" style="display:none; position: fixed; background: var(--bg-secondary); 
                     border: 1px solid var(--accent-blue); border-radius: 8px; padding: 1rem; 
                     box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 10000; max-width: 350px;
                     pointer-events: none;">
                    <div id="tooltipContent"></div>
                </div>

                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <div style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.6;">
                        ${signal.reasoning || 'Pattern detected based on insider activity'}
                    </div>
                </div>

                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                    <button class="btn btn-primary" style="flex: 1; font-size: 0.875rem;" 
                            onclick="viewDetails('${signal.ticker}')">
                        üìä View Details
                    </button>
                    <button class="btn btn-secondary" style="flex: 1; font-size: 0.875rem;"
                            onclick="addToWatchlist('${signal.ticker}')">
                        ‚≠ê Watchlist
                    </button>
                </div>
            `;

            return card;
        }

        // View details
        async function viewDetails(ticker) {
            // Show modal with detailed information
            const modal = document.getElementById('detailsModal');
            const content = document.getElementById('modalContent');
            
            modal.style.display = 'flex';
            content.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const response = await fetch(`/api/signal_details/${ticker}`);
                const data = await response.json();
                
                if (data.error) {
                    content.innerHTML = `<div style="color: var(--accent-red);">${data.error}</div>`;
                    return;
                }
                
                // Render comprehensive details
                content.innerHTML = `
                    <div style="max-width: 800px; margin: 0 auto;">
                        <h2 style="margin: 0 0 1rem 0; font-size: 2rem; color: var(--text-primary);">
                            ${data.ticker}
                            <span style="color: var(--accent-green); font-size: 1.5rem; margin-left: 1rem;">
                                ${data.strength.toFixed(0)}%
                            </span>
                        </h2>
                        
                        <div class="signal-type ${data.signal_type}" style="display: inline-block; margin-bottom: 1.5rem;">
                            ${data.signal_type.toUpperCase()} SIGNAL
                        </div>
                        
                        <!-- Detailed Reasoning -->
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--border-color);">
                            <h3 style="margin: 0 0 1rem 0; font-size: 1.2rem; color: var(--accent-blue);">üìã Analysis</h3>
                            <div style="line-height: 1.8; color: var(--text-secondary); white-space: pre-line;">
                                ${data.detailed_reasoning}
                            </div>
                        </div>
                        
                        <!-- Confidence Breakdown -->
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--border-color);">
                            <h3 style="margin: 0 0 1rem 0; font-size: 1.2rem; color: var(--accent-blue);">üìä Confidence Score Breakdown</h3>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--accent-green); margin-bottom: 1rem;">
                                ${data.confidence_breakdown.total_score}/100
                            </div>
                            <div style="display: grid; gap: 0.75rem;">
                                ${Object.entries(data.confidence_breakdown.factors).map(([name, score]) => `
                                    <div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                            <span style="color: var(--text-secondary);">${name}</span>
                                            <span style="color: var(--text-primary); font-weight: 600;">${score} pts</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: ${(score/25)*100}%"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); font-size: 0.875rem; color: var(--text-secondary);">
                                ${data.confidence_breakdown.explanation}
                            </div>
                        </div>
                        
                        <!-- Price Targets -->
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--border-color);">
                            <h3 style="margin: 0 0 1rem 0; font-size: 1.2rem; color: var(--accent-blue);">üéØ Price Targets</h3>
                            ${data.price_targets.avg_insider_buy_price ? `
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="color: var(--text-secondary); font-size: 0.875rem;">Avg Insider Buy Price</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);">
                                        $${data.price_targets.avg_insider_buy_price.toFixed(2)}
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                    <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                                        <div style="color: var(--text-secondary); font-size: 0.875rem;">üîí Stop Loss</div>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--accent-red);">
                                            $${data.price_targets.targets.stop_loss}
                                        </div>
                                        <div style="color: var(--text-secondary); font-size: 0.75rem;">-15%</div>
                                    </div>
                                    <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                                        <div style="color: var(--text-secondary); font-size: 0.875rem;">üéØ Conservative</div>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--accent-green);">
                                            $${data.price_targets.targets.conservative}
                                        </div>
                                        <div style="color: var(--accent-green); font-size: 0.75rem;">+10%</div>
                                    </div>
                                    <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                                        <div style="color: var(--text-secondary); font-size: 0.875rem;">üéØ Moderate</div>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--accent-green);">
                                            $${data.price_targets.targets.moderate}
                                        </div>
                                        <div style="color: var(--accent-green); font-size: 0.75rem;">+25%</div>
                                    </div>
                                    <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                                        <div style="color: var(--text-secondary); font-size: 0.875rem;">üöÄ Aggressive</div>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--accent-purple);">
                                            $${data.price_targets.targets.aggressive}
                                        </div>
                                        <div style="color: var(--accent-purple); font-size: 0.75rem;">+50%</div>
                                    </div>
                                </div>
                            ` : '<div style="color: var(--text-secondary);">Price targets not available</div>'}
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); font-size: 0.875rem; color: var(--text-secondary);">
                                ${data.price_targets.explanation}
                            </div>
                        </div>
                        
                        <!-- Hold Time Recommendation -->
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color);">
                            <h3 style="margin: 0 0 1rem 0; font-size: 1.2rem; color: var(--accent-blue);">‚è∞ Hold Time Recommendation</h3>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--accent-yellow); margin-bottom: 0.5rem;">
                                ${data.hold_time.recommended_days} days
                            </div>
                            <div style="color: var(--text-secondary);">
                                ${data.hold_time.explanation}
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading details:', error);
                content.innerHTML = `<div style="color: var(--accent-red);">Failed to load details</div>`;
            }
        }

        function closeModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        // Insider modal functions
        async function showInsiderModal(name) {
            const modal = document.getElementById('insiderModal');
            const content = document.getElementById('insiderModalContent');
            
            modal.style.display = 'flex';
            content.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const response = await fetch(`/api/insider_info/${encodeURIComponent(name)}`);
                const data = await response.json();
                
                if (data.error) {
                    content.innerHTML = `<div style="color: var(--accent-red);">${data.error}</div>`;
                    return;
                }
                
                // Render full insider profile
                const displayRole = data.role && data.role !== 'Unknown' ? data.role : data.filer_type || 'Insider';
                const badges = [];
                if (data.party && data.party !== 'null') badges.push(data.party);
                if (data.state && data.state !== 'null') badges.push(data.state);
                if (data.chamber && data.chamber !== 'Unknown' && data.chamber !== 'null') badges.push(data.chamber);
                
                content.innerHTML = `
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <h1 style="margin: 0 0 0.5rem 0; font-size: 2rem; color: var(--text-primary);">
                            ${data.name || 'Unknown Insider'}
                        </h1>
                        <div style="color: var(--accent-blue); font-size: 1.2rem; margin-bottom: 1rem;">
                            ${displayRole}
                        </div>
                        ${badges.length > 0 ? `<span style="background: var(--bg-card); padding: 0.5rem 1rem; border-radius: 8px; color: var(--text-secondary);">${badges.join(' ‚Ä¢ ')}</span>` : ''}
                    </div>
                    
                    <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--border-color);">
                        <h3 style="margin: 0 0 1rem 0; color: var(--accent-blue);">üí° Why This Matters</h3>
                        <div style="line-height: 1.8; color: var(--text-secondary);">
                            ${data.significance}
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-green);">${data.total_trades || 0}</div>
                            <div style="color: var(--text-secondary); margin-top: 0.5rem;">Total Trades</div>
                        </div>
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-blue);">${data.unique_tickers || 0}</div>
                            <div style="color: var(--text-secondary); margin-top: 0.5rem;">Unique Tickers</div>
                        </div>
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-green);">${data.buy_trades || 0}</div>
                            <div style="color: var(--text-secondary); margin-top: 0.5rem;">Buy Trades</div>
                        </div>
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-red);">${data.sell_trades || 0}</div>
                            <div style="color: var(--text-secondary); margin-top: 0.5rem;">Sell Trades</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px;">
                            <div style="color: var(--text-secondary); margin-bottom: 0.5rem;">Total Bought</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-green);">${formatCurrency(data.total_bought)}</div>
                        </div>
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px;">
                            <div style="color: var(--text-secondary); margin-bottom: 0.5rem;">Total Sold</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-red);">${formatCurrency(data.total_sold)}</div>
                        </div>
                    </div>
                    
                    ${data.favorite_tickers && data.favorite_tickers.length > 0 ? `
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                            <h3 style="margin: 0 0 1rem 0; color: var(--accent-blue);">üìä Favorite Tickers</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${data.favorite_tickers.map(ticker => 
                                    `<span style="background: var(--bg-secondary); padding: 0.5rem 1rem; border-radius: 8px; color: var(--accent-blue); font-weight: 600;">${ticker}</span>`
                                ).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${data.recent_trades && data.recent_trades.length > 0 ? `
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px;">
                            <h3 style="margin: 0 0 1rem 0; color: var(--accent-blue);">üìÖ Recent Activity</h3>
                            <div style="display: grid; gap: 0.75rem;">
                                ${data.recent_trades.slice(0, 10).map(trade => {
                                    const typeColor = trade.type === 'BUY' ? 'var(--accent-green)' : 'var(--accent-red)';
                                    return `
                                        <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px;">
                                            <span style="color: var(--text-primary); font-weight: 600;">${trade.ticker || 'N/A'}</span>
                                            <span style="color: ${typeColor}; font-weight: 600;">${trade.type}</span>
                                            <span style="color: var(--text-secondary);">${trade.date}</span>
                                            <span style="color: var(--text-primary);">${trade.amount ? formatCurrency(trade.amount) : 'N/A'}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;
            } catch (error) {
                console.error('Error loading insider profile:', error);
                content.innerHTML = `<div style="color: var(--accent-red);">Failed to load profile</div>`;
            }
        }

        function closeInsiderModal() {
            document.getElementById('insiderModal').style.display = 'none';
        }

        // Add to watchlist (placeholder)
        function addToWatchlist(ticker) {
            alert(`‚úÖ ${ticker} added to watchlist!\n(Feature coming soon)`);
        }

        // Export to CSV
        function exportToCSV() {
            if (allSignals.length === 0) {
                alert('No signals to export');
                return;
            }

            let csv = 'Ticker,Signal Type,Strength,Num Trades,Num Insiders,Total Volume,Reasoning\n';
            
            allSignals.forEach(signal => {
                csv += `${signal.ticker},${signal.signal_type},${signal.strength},${signal.num_trades || 0},${signal.num_insiders || 0},"${formatCurrency(signal.total_volume || 0)}","${(signal.reasoning || '').replace(/"/g, '""')}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `insider-signals-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // Auto-refresh
        function startAutoRefresh() {
            setInterval(() => {
                console.log('Auto-refreshing signals...');
                loadSignals();
            }, 60000); // Every minute
        }

        // Insider tooltip functions
        let tooltipTimeout = null;
        let insiderCache = {};

        async function showInsiderTooltip(event, name) {
            clearTimeout(tooltipTimeout);
            
            const tooltip = document.getElementById('insiderTooltip');
            const content = document.getElementById('tooltipContent');
            
            // Position tooltip near cursor
            tooltip.style.left = event.pageX + 15 + 'px';
            tooltip.style.top = event.pageY + 15 + 'px';
            tooltip.style.display = 'block';
            
            // Show loading state
            content.innerHTML = '<div style="color: var(--text-secondary);">Loading...</div>';
            
            // Fetch insider info (with caching)
            if (insiderCache[name]) {
                displayInsiderInfo(insiderCache[name]);
            } else {
                try {
                    const response = await fetch(`/api/insider_info/${encodeURIComponent(name)}`);
                    const data = await response.json();
                    
                    if (data.error) {
                        content.innerHTML = `<div style="color: var(--accent-red);">Info not available</div>`;
                    } else {
                        insiderCache[name] = data;
                        displayInsiderInfo(data);
                    }
                } catch (error) {
                    content.innerHTML = `<div style="color: var(--accent-red);">Failed to load</div>`;
                }
            }
        }

        function displayInsiderInfo(data) {
            const content = document.getElementById('tooltipContent');
            content.innerHTML = `
                <div style="font-weight: 600; font-size: 1rem; margin-bottom: 0.5rem; color: var(--text-primary);">
                    ${data.name}
                </div>
                <div style="color: var(--accent-blue); font-size: 0.875rem; margin-bottom: 0.75rem;">
                    ${data.role}
                </div>
                <div style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.5; margin-bottom: 0.75rem;">
                    ${data.significance}
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.8rem;">
                    <div>
                        <div style="color: var(--text-secondary);">Buy Trades</div>
                        <div style="color: var(--accent-green); font-weight: 600;">${data.buy_trades}</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary);">Sell Trades</div>
                        <div style="color: var(--accent-red); font-weight: 600;">${data.sell_trades}</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary);">Total Bought</div>
                        <div style="color: var(--text-primary); font-weight: 600;">${formatCurrency(data.total_bought)}</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary);">Unique Tickers</div>
                        <div style="color: var(--text-primary); font-weight: 600;">${data.unique_tickers}</div>
                    </div>
                </div>
                ${data.favorite_tickers && data.favorite_tickers.length > 0 ? `
                    <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color);">
                        <div style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 0.25rem;">FAVORITE TICKERS</div>
                        <div style="font-size: 0.85rem; color: var(--accent-blue);">${data.favorite_tickers.join(', ')}</div>
                    </div>
                ` : ''}
            `;
        }

        function hideInsiderTooltip() {
            tooltipTimeout = setTimeout(() => {
                document.getElementById('insiderTooltip').style.display = 'none';
            }, 200);
        }

        // Tab switching
        function showTab(tab) {
            const signalsTab = document.getElementById('signalsTab');
            const queryTab = document.getElementById('queryTab');
            const signalsContent = document.getElementById('signalsContent');
            const queryContent = document.getElementById('queryContent');

            if (tab === 'signals') {
                signalsTab.classList.add('active');
                queryTab.classList.remove('active');
                signalsContent.style.display = 'block';
                queryContent.style.display = 'none';
            } else {
                signalsTab.classList.remove('active');
                queryTab.classList.add('active');
                signalsContent.style.display = 'none';
                queryContent.style.display = 'block';
                
                // Set default dates
                if (!document.getElementById('queryEndDate').value) {
                    const today = new Date().toISOString().split('T')[0];
                    const ninetyDaysAgo = new Date(Date.now() - 90*24*60*60*1000).toISOString().split('T')[0];
                    document.getElementById('queryEndDate').value = today;
                    document.getElementById('queryStartDate').value = ninetyDaysAgo;
                }
            }
        }

        // Query builder functions
        let queryResultsData = [];

        async function runCustomQuery() {
            const resultsDiv = document.getElementById('queryResults');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            const filters = {
                ticker: document.getElementById('queryTicker').value.toUpperCase() || null,
                start_date: document.getElementById('queryStartDate').value || null,
                end_date: document.getElementById('queryEndDate').value || null,
                min_amount: parseFloat(document.getElementById('queryMinAmount').value) || null,
                max_amount: parseFloat(document.getElementById('queryMaxAmount').value) || null,
                transaction_type: document.getElementById('queryTxType').value || null,
                filer_type: document.getElementById('queryFilerType').value || null,
                limit: parseInt(document.getElementById('queryLimit').value) || 100
            };

            // Remove null values
            Object.keys(filters).forEach(key => {
                if (filters[key] === null) delete filters[key];
            });

            try {
                const response = await fetch('/api/query/trades', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(filters)
                });
                const data = await response.json();

                queryResultsData = data.trades || [];

                if (queryResultsData.length === 0) {
                    resultsDiv.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üì≠</div>
                            <div class="empty-title">No results found</div>
                            <div class="empty-text">Try adjusting your filters</div>
                        </div>
                    `;
                    return;
                }

                // Render table
                let tableHTML = `
                    <div style="margin-bottom: 1rem; color: var(--text-primary);">
                        <strong>${data.count}</strong> trades found
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="query-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Ticker</th>
                                    <th>Insider</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Price</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                queryResultsData.forEach(trade => {
                    const typeColor = trade.type === 'BUY' ? 'var(--accent-green)' : 'var(--accent-red)';
                    tableHTML += `
                        <tr>
                            <td>${trade.date}</td>
                            <td style="font-weight: 600; color: var(--accent-blue);">${trade.ticker || 'N/A'}</td>
                            <td>${trade.insider || 'Unknown'}</td>
                            <td style="color: ${typeColor}; font-weight: 600;">${trade.type}</td>
                            <td>${trade.amount ? formatCurrency(trade.amount) : 'N/A'}</td>
                            <td>${trade.price ? '$' + trade.price.toFixed(2) : 'N/A'}</td>
                        </tr>
                    `;
                });

                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;

                resultsDiv.innerHTML = tableHTML;

            } catch (error) {
                console.error('Error running query:', error);
                resultsDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ö†Ô∏è</div>
                        <div class="empty-title">Error running query</div>
                        <div class="empty-text">${error.message}</div>
                    </div>
                `;
            }
        }

        function exportQueryResults() {
            if (queryResultsData.length === 0) {
                alert('No results to export. Run a query first.');
                return;
            }

            let csv = 'Date,Ticker,Insider,Type,Amount,Price\n';
            queryResultsData.forEach(trade => {
                csv += `${trade.date},${trade.ticker || 'N/A'},${trade.insider || 'Unknown'},${trade.type},"${formatCurrency(trade.amount || 0)}","${trade.price ? '$' + trade.price.toFixed(2) : 'N/A'}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trade-query-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function clearQueryFilters() {
            document.getElementById('queryTicker').value = '';
            document.getElementById('queryStartDate').value = '';
            document.getElementById('queryEndDate').value = '';
            document.getElementById('queryMinAmount').value = '';
            document.getElementById('queryMaxAmount').value = '';
            document.getElementById('queryTxType').value = '';
            document.getElementById('queryFilerType').value = '';
            document.getElementById('queryLimit').value = '100';
            document.getElementById('queryResults').innerHTML = `
                <div style="text-align: center; padding: 4rem 2rem; color: var(--text-secondary);">
                    Configure your filters and click "Run Query" to see results
                </div>
            `;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadSignals();
            startAutoRefresh();

            // Add event listeners for filters
            document.getElementById('riskTolerance').addEventListener('change', loadSignals);
            document.getElementById('marketCap').addEventListener('change', loadSignals);
            document.getElementById('minConfidence').addEventListener('change', loadSignals);
            document.getElementById('resultsLimit').addEventListener('change', loadSignals);
        });
    </script>
</body>
</html>

