<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insider Trading Intelligence Platform</title>
    <link rel="stylesheet" href="/static/css/premium.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                üìä Insider Intelligence
            </div>
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-label">Total Trades</div>
                    <div class="stat-value" id="totalTrades">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Active Signals</div>
                    <div class="stat-value" id="activeSignals">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Total Volume</div>
                    <div class="stat-value" id="totalVolume">$-</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Tabs -->
        <div style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 2px solid var(--border-color);">
            <button class="tab-btn active" onclick="showTab('signals')" id="signalsTab">
                üìä Signals
            </button>
            <button class="tab-btn" onclick="showTab('query')" id="queryTab">
                üîç Query Builder
            </button>
            <button class="tab-btn" onclick="showTab('broker')" id="brokerTab">
                üè¶ Broker
            </button>
        </div>

        <!-- Signals Tab -->
        <div id="signalsContent">
            <!-- Filters -->
        <div class="filters">
            <div class="filter-grid">
                <div class="filter-group">
                    <label class="filter-label">Risk Tolerance</label>
                    <select class="filter-select" id="riskTolerance">
                        <option value="conservative">Conservative</option>
                        <option value="moderate" selected>Moderate</option>
                        <option value="aggressive">Aggressive</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Market Cap</label>
                    <select class="filter-select" id="marketCap">
                        <option value="all" selected>All Caps</option>
                        <option value="mega">Mega Cap (>$200B)</option>
                        <option value="large">Large Cap ($10-200B)</option>
                        <option value="mid">Mid Cap ($2-10B)</option>
                        <option value="small">Small Cap ($300M-$2B)</option>
                        <option value="micro">Micro Cap (<$300M)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Min Confidence</label>
                    <select class="filter-select" id="minConfidence">
                        <option value="0">All (0%)</option>
                        <option value="50">Above 50%</option>
                        <option value="75">Above 75%</option>
                        <option value="90">Above 90%</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Results Limit</label>
                    <select class="filter-select" id="resultsLimit">
                        <option value="10">10 signals</option>
                        <option value="25">25 signals</option>
                        <option value="50" selected>50 signals</option>
                        <option value="100">100 signals</option>
                    </select>
                </div>
            </div>
            <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                <button class="btn btn-primary" onclick="loadSignals()">
                    üîÑ Refresh Signals
                </button>
                <button class="btn btn-secondary" onclick="exportSignalsToCSV()">
                    üì• Export to CSV
                </button>
            </div>
        </div>

            <!-- Signals Grid -->
            <div id="signalsContainer">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Query Builder Tab -->
        <div id="queryContent" style="display: none;">
            <div class="filters">
                <h3 style="margin: 0 0 1rem 0; color: var(--text-primary);">üîç Custom Trade Query Builder</h3>
                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label">Ticker (optional)</label>
                        <input type="text" class="filter-input" id="queryTicker" placeholder="e.g. NVDA">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Start Date</label>
                        <input type="date" class="filter-input" id="queryStartDate">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">End Date</label>
                        <input type="date" class="filter-input" id="queryEndDate">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Min Amount ($)</label>
                        <input type="number" class="filter-input" id="queryMinAmount" placeholder="e.g. 100000">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Max Amount ($)</label>
                        <input type="number" class="filter-input" id="queryMaxAmount" placeholder="e.g. 5000000">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Transaction Type</label>
                        <select class="filter-select" id="queryTxType">
                            <option value="">All Types</option>
                            <option value="BUY">Buy</option>
                            <option value="SELL">Sell</option>
                            <option value="OPTION_EXERCISE">Option Exercise</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Filer Type</label>
                        <select class="filter-select" id="queryFilerType">
                            <option value="">All Types</option>
                            <option value="POLITICIAN">Politician</option>
                            <option value="CORPORATE_INSIDER">Corporate Insider</option>
                            <option value="INSTITUTIONAL_INVESTOR">Institutional</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Results Limit</label>
                        <select class="filter-select" id="queryLimit">
                            <option value="50">50 results</option>
                            <option value="100" selected>100 results</option>
                            <option value="200">200 results</option>
                            <option value="500">500 results</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                    <button class="btn btn-primary" onclick="runCustomQuery()">
                        üîç Run Query
                    </button>
                    <button class="btn btn-secondary" onclick="exportTradesToCSV()">
                        üì• Export Results
                    </button>
                    <button class="btn btn-secondary" onclick="clearQueryFilters()">
                        üîÑ Clear Filters
                    </button>
                </div>
            </div>

            <!-- Query Results -->
            <div id="queryResults" style="margin-top: 2rem;">
                <div style="text-align: center; padding: 4rem 2rem; color: var(--text-secondary);">
                    Configure your filters and click "Run Query" to see results
                </div>
            </div>
        </div>

        <!-- Broker Tab -->
        <div id="brokerContent" style="display: none;">
            <div style="margin-bottom: 2rem;">
                <h2 style="margin: 0 0 1rem 0; color: var(--text-primary);">üè¶ Broker Connections</h2>
                <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                    Connect your brokerage accounts to execute trades directly from signals. 
                    <strong>Note:</strong> OAuth authentication requires manual setup - see documentation.
                </p>
                
                <!-- Broker Status Cards -->
                <div id="brokerStatusCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div class="loading">Loading broker status...</div>
                </div>
                
                <!-- Account Positions (if authenticated) -->
                <div id="brokerPositions" style="display: none;">
                    <h3 style="margin: 2rem 0 1rem 0; color: var(--text-primary);">üìä Current Positions</h3>
                    <div class="table-container">
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Quantity</th>
                                    <th>Avg Price</th>
                                    <th>Current Price</th>
                                    <th>Market Value</th>
                                    <th>Unrealized P/L</th>
                                    <th>Return %</th>
                                </tr>
                            </thead>
                            <tbody id="positionsTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                        No positions loaded
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Setup Instructions -->
                <div style="margin-top: 2rem; padding: 1.5rem; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color);">
                    <h3 style="margin: 0 0 1rem 0; color: var(--text-primary);">üìù Setup Instructions</h3>
                    <div style="color: var(--text-secondary); line-height: 1.6;">
                        <p><strong>Schwab Trader API:</strong></p>
                        <ol>
                            <li>Register at <a href="https://developer.schwab.com/" target="_blank" style="color: var(--accent-color);">developer.schwab.com</a></li>
                            <li>Create an app and get your App Key & Secret</li>
                            <li>Add to <code>.env</code>: <code>SCHWAB_APP_KEY</code>, <code>SCHWAB_APP_SECRET</code></li>
                            <li>Run OAuth flow to authenticate (see documentation)</li>
                        </ol>
                        
                        <p style="margin-top: 1.5rem;"><strong>E*TRADE API:</strong></p>
                        <ol>
                            <li>Register at <a href="https://developer.etrade.com/" target="_blank" style="color: var(--accent-color);">developer.etrade.com</a></li>
                            <li>Create an app and get your Consumer Key & Secret</li>
                            <li>Add to <code>.env</code>: <code>ETRADE_CONSUMER_KEY</code>, <code>ETRADE_CONSUMER_SECRET</code></li>
                            <li>Set <code>ETRADE_SANDBOX=true</code> for testing</li>
                            <li>Run OAuth flow to authenticate (see documentation)</li>
                        </ol>
                        
                        <p style="margin-top: 1.5rem;"><strong>‚ö†Ô∏è Important:</strong></p>
                        <ul>
                            <li>OAuth authentication requires browser interaction and cannot be fully automated</li>
                            <li>Start with sandbox/paper trading accounts for testing</li>
                            <li>Never commit API keys to version control</li>
                            <li>Review all orders before execution</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Signal Details Modal -->
    <div id="detailsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
         background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;
         padding: 2rem; overflow-y: auto;" onclick="if(event.target === this) closeModal()">
        <div style="background: var(--bg-secondary); border-radius: 16px; padding: 2rem; 
             max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; 
             border: 1px solid var(--border-color); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0; font-size: 1.5rem;">Signal Details</h2>
                <button onclick="closeModal()" style="background: none; border: none; color: var(--text-secondary); 
                        font-size: 2rem; cursor: pointer; padding: 0; width: 40px; height: 40px; 
                        display: flex; align-items: center; justify-content: center; border-radius: 8px; 
                        transition: all 0.2s;" onmouseover="this.style.background='var(--bg-card)'; this.style.color='var(--text-primary)'" 
                        onmouseout="this.style.background='none'; this.style.color='var(--text-secondary)'">√ó</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Insider Profile Modal -->
    <div id="insiderModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
         background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;
         padding: 2rem; overflow-y: auto;" onclick="if(event.target === this) closeInsiderModal()">
        <div style="background: var(--bg-secondary); border-radius: 16px; padding: 2rem; 
             max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; 
             border: 1px solid var(--border-color); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0; font-size: 1.5rem;">üë§ Insider Profile</h2>
                <button onclick="closeInsiderModal()" style="background: none; border: none; color: var(--text-secondary); 
                        font-size: 2rem; cursor: pointer; padding: 0; width: 40px; height: 40px; 
                        display: flex; align-items: center; justify-content: center; border-radius: 8px; 
                        transition: all 0.2s;" onmouseover="this.style.background='var(--bg-card)'; this.style.color='var(--text-primary)'" 
                        onmouseout="this.style.background='none'; this.style.color='var(--text-secondary)'">√ó</button>
            </div>
            <div id="insiderModalContent"></div>
        </div>
    </div>

    <script>
        // Global data
        let allSignals = [];

        // Format currency
        function formatCurrency(value) {
            if (!value) return '$0';
            if (value >= 1e9) return '$' + (value / 1e9).toFixed(2) + 'B';
            if (value >= 1e6) return '$' + (value / 1e6).toFixed(2) + 'M';
            if (value >= 1e3) return '$' + (value / 1e3).toFixed(2) + 'K';
            return '$' + value.toFixed(2);
        }

        // Load stats
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                document.getElementById('totalTrades').textContent = 
                    (data.total_trades || 0).toLocaleString();
                document.getElementById('totalVolume').textContent = 
                    formatCurrency(data.total_volume || 0);
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load signals
        async function loadSignals() {
            const container = document.getElementById('signalsContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const risk = document.getElementById('riskTolerance').value;
                const marketCap = document.getElementById('marketCap').value;
                const minConf = document.getElementById('minConfidence').value;
                const limit = document.getElementById('resultsLimit').value;

                const url = `/api/signals/enhanced?risk=${risk}&market_cap=${marketCap}&min_confidence=${minConf}&limit=${limit}`;
                const response = await fetch(url);
                const data = await response.json();

                allSignals = data.signals || [];
                
                // Update stats
                document.getElementById('activeSignals').textContent = allSignals.length;

                if (allSignals.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üì≠</div>
                            <div class="empty-title">No signals found</div>
                            <div class="empty-text">Try adjusting your filters or check back later</div>
                        </div>
                    `;
                    return;
                }

                // Render signals
                container.innerHTML = '<div class="signals-grid" id="signalsGrid"></div>';
                const grid = document.getElementById('signalsGrid');

                allSignals.forEach((signal, index) => {
                    const card = createSignalCard(signal, index);
                    grid.appendChild(card);
                });
                
                // Load backtest badges and price data for all signals
                allSignals.forEach(signal => {
                    loadBacktestBadge(signal.ticker);
                    loadPriceData(signal.ticker);
                });

            } catch (error) {
                console.error('Error loading signals:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ö†Ô∏è</div>
                        <div class="empty-title">Error loading signals</div>
                        <div class="empty-text">${error.message}</div>
                    </div>
                `;
            }
        }

        // Create signal card
        function createSignalCard(signal, index) {
            const card = document.createElement('div');
            card.className = 'signal-card';
            card.style.animationDelay = `${index * 0.05}s`;

            card.innerHTML = `
                <div class="signal-header">
                    <div class="ticker">${signal.ticker}</div>
                    <div class="strength-badge">${signal.strength.toFixed(0)}%</div>
                </div>
                
                <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.75rem;">
                    <span class="signal-type ${signal.signal_type}">${signal.signal_type}</span>
                    <span id="backtest_badge_${signal.ticker}" style="font-size: 0.7rem; padding: 0.2rem 0.5rem; 
                          background: rgba(100,100,100,0.2); color: var(--text-secondary); 
                          border-radius: 12px; opacity: 0.6;">‚è≥</span>
                </div>
                
                <!-- Market Data Section -->
                <div id="price_${signal.ticker}" style="background: rgba(56, 189, 248, 0.1); padding: 0.75rem; 
                     border-radius: 8px; margin-bottom: 1rem; border: 1px solid rgba(56, 189, 248, 0.3);">
                    <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); font-size: 0.75rem;">
                        <span>üí∞</span>
                        <span>Loading price...</span>
                    </div>
                </div>
                
                <div class="insider-info">
                    <div class="info-item">
                        <span class="info-label">Total Trades</span>
                        <span class="info-value highlight">${signal.num_trades || 0}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Unique Insiders</span>
                        <span class="info-value highlight">${signal.num_insiders || 0}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Total Volume</span>
                        <span class="info-value">${formatCurrency(signal.total_volume || 0)}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Buy Trades</span>
                        <span class="info-value">${signal.num_buys || 0}</span>
                    </div>
                </div>

                <div class="insider-list">
                    <div class="insider-list-title">üè¢ Top Insiders (hover for details, click for full profile)</div>
                    <div class="insider-tags">
                        ${signal.insiders && signal.insiders.length > 0 
                            ? signal.insiders.slice(0, 5).map(name => 
                                `<span class="insider-tag insider-hover" 
                                      data-insider="${name}" 
                                      onmouseenter="showInsiderTooltip(event, '${name.replace(/'/g, "\\'")}')"
                                      onmouseleave="hideInsiderTooltip()"
                                      onclick="showInsiderModal('${name.replace(/'/g, "\\'")}')"
                                      style="cursor: pointer;"
                                      title="Hover for quick info, click for full profile">${name.slice(0, 20)}${name.length > 20 ? '...' : ''}</span>`
                              ).join('')
                            : '<span class="insider-tag">No names available</span>'}
                    </div>
                </div>
                
                <!-- Insider Tooltip -->
                <div id="insiderTooltip" style="display:none; position: fixed; background: var(--bg-secondary); 
                     border: 1px solid var(--accent-blue); border-radius: 8px; padding: 1rem; 
                     box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 10000; max-width: 350px;
                     pointer-events: none;">
                    <div id="tooltipContent"></div>
                </div>

                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <div style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.6;">
                        ${signal.reasoning || 'Pattern detected based on insider activity'}
                    </div>
                </div>

                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                    <button class="btn btn-primary" style="flex: 1; font-size: 0.875rem;" 
                            onclick="viewDetails('${signal.ticker}')">
                        üìä View Details
                    </button>
                    <button class="btn btn-secondary" style="flex: 1; font-size: 0.875rem;"
                            onclick="addToWatchlist('${signal.ticker}')">
                        ‚≠ê Watchlist
                    </button>
                </div>
            `;

            return card;
        }

        // View details
        async function viewDetails(ticker) {
            // Show modal with detailed information
            const modal = document.getElementById('detailsModal');
            const content = document.getElementById('modalContent');
            
            modal.style.display = 'flex';
            content.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const response = await fetch(`/api/signal_details/${ticker}`);
                const data = await response.json();
                
                if (data.error) {
                    content.innerHTML = `<div style="color: var(--accent-red);">${data.error}</div>`;
                    return;
                }
                
                // Render comprehensive details
                content.innerHTML = `
                    <div style="max-width: 800px; margin: 0 auto;">
                        <h2 style="margin: 0 0 1rem 0; font-size: 2rem; color: var(--text-primary);">
                            ${data.ticker}
                            <span style="color: var(--accent-green); font-size: 1.5rem; margin-left: 1rem;">
                                ${data.strength.toFixed(0)}%
                            </span>
                        </h2>
                        
                        <div class="signal-type ${data.signal_type}" style="display: inline-block; margin-bottom: 1.5rem;">
                            ${data.signal_type.toUpperCase()} SIGNAL
                        </div>
                        
                        <!-- Detailed Reasoning -->
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--border-color);">
                            <h3 style="margin: 0 0 1rem 0; font-size: 1.2rem; color: var(--accent-blue);">üìã Analysis</h3>
                            <div style="line-height: 1.8; color: var(--text-secondary); white-space: pre-line;">
                                ${data.detailed_reasoning}
                            </div>
                        </div>
                        
                        <!-- Confidence Breakdown -->
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--border-color);">
                            <h3 style="margin: 0 0 1rem 0; font-size: 1.2rem; color: var(--accent-blue);">üìä Confidence Score Breakdown</h3>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--accent-green); margin-bottom: 1rem;">
                                ${data.confidence_breakdown.total_score}/100
                            </div>
                            <div style="display: grid; gap: 0.75rem;">
                                ${Object.entries(data.confidence_breakdown.factors).map(([name, score]) => `
                                    <div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                            <span style="color: var(--text-secondary);">${name}</span>
                                            <span style="color: var(--text-primary); font-weight: 600;">${score} pts</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: ${(score/25)*100}%"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); font-size: 0.875rem; color: var(--text-secondary);">
                                ${data.confidence_breakdown.explanation}
                            </div>
                        </div>
                        
                        <!-- Price Targets -->
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--border-color);">
                            <h3 style="margin: 0 0 1rem 0; font-size: 1.2rem; color: var(--accent-blue);">üéØ Price Targets</h3>
                            ${data.price_targets.avg_insider_buy_price ? `
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="color: var(--text-secondary); font-size: 0.875rem;">Avg Insider Buy Price</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);">
                                        $${data.price_targets.avg_insider_buy_price.toFixed(2)}
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                    <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                                        <div style="color: var(--text-secondary); font-size: 0.875rem;">üîí Stop Loss</div>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--accent-red);">
                                            $${data.price_targets.targets.stop_loss}
                                        </div>
                                        <div style="color: var(--text-secondary); font-size: 0.75rem;">-15%</div>
                                    </div>
                                    <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                                        <div style="color: var(--text-secondary); font-size: 0.875rem;">üéØ Conservative</div>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--accent-green);">
                                            $${data.price_targets.targets.conservative}
                                        </div>
                                        <div style="color: var(--accent-green); font-size: 0.75rem;">+10%</div>
                                    </div>
                                    <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                                        <div style="color: var(--text-secondary); font-size: 0.875rem;">üéØ Moderate</div>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--accent-green);">
                                            $${data.price_targets.targets.moderate}
                                        </div>
                                        <div style="color: var(--accent-green); font-size: 0.75rem;">+25%</div>
                                    </div>
                                    <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                                        <div style="color: var(--text-secondary); font-size: 0.875rem;">üöÄ Aggressive</div>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--accent-purple);">
                                            $${data.price_targets.targets.aggressive}
                                        </div>
                                        <div style="color: var(--accent-purple); font-size: 0.75rem;">+50%</div>
                                    </div>
                                </div>
                            ` : '<div style="color: var(--text-secondary);">Price targets not available</div>'}
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); font-size: 0.875rem; color: var(--text-secondary);">
                                ${data.price_targets.explanation}
                            </div>
                        </div>
                        
                        <!-- Hold Time Recommendation -->
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 1.5rem;">
                            <h3 style="margin: 0 0 1rem 0; font-size: 1.2rem; color: var(--accent-blue);">‚è∞ Hold Time Recommendation</h3>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--accent-yellow); margin-bottom: 0.5rem;">
                                ${data.hold_time.recommended_days} days
                            </div>
                            <div style="color: var(--text-secondary);">
                                ${data.hold_time.explanation}
                            </div>
                        </div>
                        
                        <!-- Historical Backtest Performance -->
                        <div id="backtestSection_${data.ticker}" style="background: linear-gradient(135deg, rgba(56, 189, 248, 0.1), rgba(168, 85, 247, 0.1)); 
                                 padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(56, 189, 248, 0.3);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                <h3 style="margin: 0; font-size: 1.2rem; color: var(--accent-blue);">
                                    üéØ Historical Performance
                                </h3>
                                <span style="background: rgba(56, 189, 248, 0.2); padding: 0.25rem 0.75rem; 
                                       border-radius: 20px; font-size: 0.75rem; color: var(--accent-blue);">
                                    BACKTESTED
                                </span>
                            </div>
                            <div class="loading-mini" style="text-align: center; padding: 2rem;">
                                <div style="color: var(--text-secondary);">Loading historical data...</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Load backtesting data asynchronously
                loadBacktestData(data.ticker);
                
            } catch (error) {
                console.error('Error loading details:', error);
                content.innerHTML = `<div style="color: var(--accent-red);">Failed to load details</div>`;
            }
        }
        
        async function loadBacktestData(ticker) {
            try {
                const response = await fetch(`/api/backtest/ticker/${ticker}/quick`);
                const backtest = await response.json();
                
                const section = document.getElementById(`backtestSection_${ticker}`);
                if (!section) return;
                
                if (backtest.error) {
                    section.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                            <h3 style="margin: 0; font-size: 1.2rem; color: var(--accent-blue);">
                                üéØ Historical Performance
                            </h3>
                        </div>
                        <div style="color: var(--text-secondary); text-align: center; padding: 1rem;">
                            ${backtest.error}
                        </div>
                    `;
                    return;
                }
                
                // Get 30-day stats as default
                const stats30d = backtest.aggregate_stats['30d'] || {};
                const stats7d = backtest.aggregate_stats['7d'] || {};
                const stats14d = backtest.aggregate_stats['14d'] || {};
                
                // Determine quality badge
                let qualityBadge = '';
                let qualityColor = '';
                if (stats30d.win_rate >= 80) {
                    qualityBadge = 'EXCELLENT TRACK RECORD';
                    qualityColor = 'var(--accent-green)';
                } else if (stats30d.win_rate >= 70) {
                    qualityBadge = 'STRONG TRACK RECORD';
                    qualityColor = 'var(--accent-blue)';
                } else if (stats30d.win_rate >= 60) {
                    qualityBadge = 'GOOD TRACK RECORD';
                    qualityColor = 'var(--accent-yellow)';
                } else if (stats30d.win_rate >= 50) {
                    qualityBadge = 'AVERAGE';
                    qualityColor = 'var(--text-secondary)';
                } else {
                    qualityBadge = 'POOR TRACK RECORD';
                    qualityColor = 'var(--accent-red)';
                }
                
                section.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <h3 style="margin: 0; font-size: 1.2rem; color: var(--accent-blue);">
                                üéØ Historical Performance
                            </h3>
                            <span style="background: rgba(56, 189, 248, 0.2); padding: 0.25rem 0.75rem; 
                                   border-radius: 20px; font-size: 0.75rem; color: var(--accent-blue);">
                                BACKTESTED
                            </span>
                        </div>
                        <span style="background: ${qualityColor}22; color: ${qualityColor}; 
                               padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">
                            ${qualityBadge}
                        </span>
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.3); padding: 1.25rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.75rem;">
                            Following ${ticker} insider trades historically has returned:
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.75rem; font-weight: 700; color: ${stats7d.avg_return >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                                    ${stats7d.avg_return >= 0 ? '+' : ''}${stats7d.avg_return}%
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                    7 days
                                </div>
                                <div style="font-size: 0.75rem; color: ${stats7d.win_rate >= 70 ? 'var(--accent-green)' : stats7d.win_rate >= 50 ? 'var(--accent-yellow)' : 'var(--accent-red)'};">
                                    ${stats7d.win_rate}% win
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.75rem; font-weight: 700; color: ${stats14d.avg_return >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                                    ${stats14d.avg_return >= 0 ? '+' : ''}${stats14d.avg_return}%
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                    14 days
                                </div>
                                <div style="font-size: 0.75rem; color: ${stats14d.win_rate >= 70 ? 'var(--accent-green)' : stats14d.win_rate >= 50 ? 'var(--accent-yellow)' : 'var(--accent-red)'};">
                                    ${stats14d.win_rate}% win
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.75rem; font-weight: 700; color: ${stats30d.avg_return >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                                    ${stats30d.avg_return >= 0 ? '+' : ''}${stats30d.avg_return}%
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                    30 days
                                </div>
                                <div style="font-size: 0.75rem; color: ${stats30d.win_rate >= 70 ? 'var(--accent-green)' : stats30d.win_rate >= 50 ? 'var(--accent-yellow)' : 'var(--accent-red)'};">
                                    ${stats30d.win_rate}% win
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                        <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                                Best Trade (30d)
                            </div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-green);">
                                +${stats30d.best_return}%
                            </div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                                Worst Trade (30d)
                            </div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${stats30d.worst_return >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                                ${stats30d.worst_return >= 0 ? '+' : ''}${stats30d.worst_return}%
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px; 
                                border-left: 3px solid ${qualityColor};">
                        <div style="font-size: 0.875rem; line-height: 1.6; color: var(--text-secondary);">
                            ${getBacktestRecommendation(stats30d, backtest.total_trades_analyzed)}
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">
                            Based on ${backtest.total_trades_analyzed} historical insider trades
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading backtest:', error);
                const section = document.getElementById(`backtestSection_${ticker}`);
                if (section) {
                    section.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                            <h3 style="margin: 0; font-size: 1.2rem; color: var(--accent-blue);">
                                üéØ Historical Performance
                            </h3>
                        </div>
                        <div style="color: var(--text-secondary); text-align: center; padding: 1rem;">
                            Unable to load historical data
                        </div>
                    `;
                }
            }
        }
        
        function getBacktestRecommendation(stats, totalTrades) {
            const winRate = stats.win_rate || 0;
            const avgReturn = stats.avg_return || 0;
            
            if (winRate >= 80 && avgReturn >= 10) {
                return `<strong style="color: var(--accent-green);">üöÄ STRONG BUY:</strong> Following ${totalTrades} insider trades in this ticker has been highly profitable with an ${winRate}% win rate and average ${avgReturn}% return. This is an excellent signal to follow.`;
            } else if (winRate >= 70 && avgReturn >= 5) {
                return `<strong style="color: var(--accent-blue);">‚úÖ BUY:</strong> Historical data shows ${winRate}% of insider trades were profitable with ${avgReturn}% average return over ${totalTrades} trades. Positive track record supports this signal.`;
            } else if (winRate >= 60) {
                return `<strong style="color: var(--accent-yellow);">üëç CONSIDER:</strong> Based on ${totalTrades} trades, insiders have a ${winRate}% win rate. Decent but not exceptional performance. Consider as part of diversified strategy.`;
            } else if (winRate >= 50) {
                return `<strong style="color: var(--text-secondary);">‚ö†Ô∏è NEUTRAL:</strong> Mixed results with ${winRate}% win rate. Following insiders in this ticker has shown average performance. Use caution.`;
            } else {
                return `<strong style="color: var(--accent-red);">‚ùå CAUTION:</strong> Historical data shows only ${winRate}% win rate. Following insider trades in this ticker has not been consistently profitable. Consider alternative opportunities.`;
            }
        }
        
        async function loadBacktestBadge(ticker) {
            const badge = document.getElementById(`backtest_badge_${ticker}`);
            if (!badge) return;
            
            try {
                const response = await fetch(`/api/backtest/ticker/${ticker}/quick`);
                const backtest = await response.json();
                
                if (backtest.error || !backtest.aggregate_stats || !backtest.aggregate_stats['30d']) {
                    badge.style.display = 'none';
                    return;
                }
                
                const stats = backtest.aggregate_stats['30d'];
                const winRate = stats.win_rate || 0;
                const avgReturn = stats.avg_return || 0;
                
                let badgeText = '';
                let badgeColor = '';
                let badgeBackground = '';
                
                if (winRate >= 80 && avgReturn >= 10) {
                    badgeText = '‚úÖ PROVEN';
                    badgeColor = 'var(--accent-green)';
                    badgeBackground = 'rgba(34, 197, 94, 0.2)';
                } else if (winRate >= 70 && avgReturn >= 5) {
                    badgeText = '‚úÖ STRONG';
                    badgeColor = 'var(--accent-blue)';
                    badgeBackground = 'rgba(56, 189, 248, 0.2)';
                } else if (winRate >= 60) {
                    badgeText = 'üëç GOOD';
                    badgeColor = 'var(--accent-yellow)';
                    badgeBackground = 'rgba(250, 204, 21, 0.2)';
                } else {
                    // Don't show badge for average or poor performance
                    badge.style.display = 'none';
                    return;
                }
                
                badge.textContent = badgeText;
                badge.style.color = badgeColor;
                badge.style.background = badgeBackground;
                badge.style.opacity = '1';
                badge.title = `Win Rate: ${winRate}%, Avg Return: ${avgReturn >= 0 ? '+' : ''}${avgReturn}% (30d)`;
                
            } catch (error) {
                badge.style.display = 'none';
            }
        }
        
        async function loadPriceData(ticker) {
            const priceSection = document.getElementById(`price_${ticker}`);
            if (!priceSection) return;
            
            try {
                // Fetch both current price and entry quality
                const [priceRes, entryRes] = await Promise.all([
                    fetch(`/api/price/${ticker}`),
                    fetch(`/api/price/${ticker}/entry_quality`)
                ]);
                
                const priceData = await priceRes.json();
                const entryData = await entryRes.json();
                
                if (priceData.error && entryData.error) {
                    priceSection.style.display = 'none';
                    return;
                }
                
                const currentPrice = priceData.current_price || priceData.price || 0;
                const change = priceData.change_percent || 0;
                const changeColor = change >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                
                let entryQuality = '';
                let entryColor = '';
                
                if (!entryData.error && entryData.entry_quality) {
                    const quality = entryData.entry_quality.rating;
                    if (quality === 'EXCELLENT') {
                        entryQuality = 'üü¢ Excellent Entry';
                        entryColor = 'var(--accent-green)';
                    } else if (quality === 'VERY GOOD') {
                        entryQuality = 'üü¢ Very Good';
                        entryColor = 'var(--accent-green)';
                    } else if (quality === 'GOOD') {
                        entryQuality = 'üü° Good Entry';
                        entryColor = 'var(--accent-yellow)';
                    } else if (quality === 'FAIR') {
                        entryQuality = 'üü° Fair Entry';
                        entryColor = 'var(--accent-yellow)';
                    } else if (quality === 'POOR') {
                        entryQuality = 'üî¥ Poor Entry';
                        entryColor = 'var(--accent-red)';
                    }
                }
                
                priceSection.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.25rem;">
                                Current Price
                            </div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--text-primary);">
                                $${currentPrice.toFixed(2)}
                            </div>
                            <div style="font-size: 0.75rem; color: ${changeColor}; margin-top: 0.25rem;">
                                ${change >= 0 ? '+' : ''}${change.toFixed(2)}% today
                            </div>
                        </div>
                        ${entryQuality ? `
                            <div style="text-align: right;">
                                <div style="font-size: 0.8rem; font-weight: 600; color: ${entryColor};">
                                    ${entryQuality}
                                </div>
                                ${entryData.entry_quality.percent_vs_avg ? `
                                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                        ${entryData.entry_quality.percent_vs_avg >= 0 ? '+' : ''}${entryData.entry_quality.percent_vs_avg.toFixed(1)}% vs insiders
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
                
            } catch (error) {
                console.error(`Error loading price for ${ticker}:`, error);
                priceSection.style.display = 'none';
            }
        }

        function closeModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        // Insider modal functions
        async function showInsiderModal(name) {
            const modal = document.getElementById('insiderModal');
            const content = document.getElementById('insiderModalContent');
            
            modal.style.display = 'flex';
            content.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const response = await fetch(`/api/insider_info/${encodeURIComponent(name)}`);
                const data = await response.json();
                
                if (data.error) {
                    content.innerHTML = `<div style="color: var(--accent-red);">${data.error}</div>`;
                    return;
                }
                
                // Render full insider profile
                const displayRole = data.role && data.role !== 'Unknown' ? data.role : data.filer_type || 'Insider';
                const badges = [];
                if (data.party && data.party !== 'null') badges.push(data.party);
                if (data.state && data.state !== 'null') badges.push(data.state);
                if (data.chamber && data.chamber !== 'Unknown' && data.chamber !== 'null') badges.push(data.chamber);
                
                content.innerHTML = `
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <h1 style="margin: 0 0 0.5rem 0; font-size: 2rem; color: var(--text-primary);">
                            ${data.name || 'Unknown Insider'}
                        </h1>
                        <div style="color: var(--accent-blue); font-size: 1.2rem; margin-bottom: 1rem;">
                            ${displayRole}
                        </div>
                        ${badges.length > 0 ? `<span style="background: var(--bg-card); padding: 0.5rem 1rem; border-radius: 8px; color: var(--text-secondary);">${badges.join(' ‚Ä¢ ')}</span>` : ''}
                    </div>
                    
                    ${data.bio ? `
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--border-color);">
                            <h3 style="margin: 0 0 1rem 0; color: var(--accent-blue);">üë§ Biography</h3>
                            <div style="line-height: 1.8; color: var(--text-secondary);">
                                ${data.bio}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${data.committees && data.committees.length > 0 ? `
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--border-color);">
                            <h3 style="margin: 0 0 1rem 0; color: var(--accent-blue);">üèõÔ∏è Committee Assignments</h3>
                            <div style="display: grid; gap: 0.5rem;">
                                ${data.committees.map(c => 
                                    `<div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--accent-green);">
                                        <strong>${c.name}</strong>
                                        ${c.role ? ` - ${c.role}` : ''}
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--border-color);">
                        <h3 style="margin: 0 0 1rem 0; color: var(--accent-blue);">üí° Why This Matters</h3>
                        <div style="line-height: 1.8; color: var(--text-secondary);">
                            ${data.significance || 'Their position provides access to non-public information that can influence trading decisions.'}
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-green);">${data.total_trades || 0}</div>
                            <div style="color: var(--text-secondary); margin-top: 0.5rem;">Total Trades</div>
                        </div>
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-blue);">${data.unique_tickers || 0}</div>
                            <div style="color: var(--text-secondary); margin-top: 0.5rem;">Unique Tickers</div>
                        </div>
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-green);">${data.buy_trades || 0}</div>
                            <div style="color: var(--text-secondary); margin-top: 0.5rem;">Buy Trades</div>
                        </div>
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-red);">${data.sell_trades || 0}</div>
                            <div style="color: var(--text-secondary); margin-top: 0.5rem;">Sell Trades</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px;">
                            <div style="color: var(--text-secondary); margin-bottom: 0.5rem;">Total Bought</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-green);">${formatCurrency(data.total_bought)}</div>
                        </div>
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px;">
                            <div style="color: var(--text-secondary); margin-bottom: 0.5rem;">Total Sold</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-red);">${formatCurrency(data.total_sold)}</div>
                        </div>
                    </div>
                    
                    ${data.favorite_tickers && data.favorite_tickers.length > 0 ? `
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                            <h3 style="margin: 0 0 1rem 0; color: var(--accent-blue);">üìä Favorite Tickers</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${data.favorite_tickers.map(ticker => 
                                    `<span style="background: var(--bg-secondary); padding: 0.5rem 1rem; border-radius: 8px; color: var(--accent-blue); font-weight: 600;">${ticker}</span>`
                                ).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${data.recent_trades && data.recent_trades.length > 0 ? `
                        <div style="background: var(--bg-card); padding: 1.5rem; border-radius: 12px;">
                            <h3 style="margin: 0 0 1rem 0; color: var(--accent-blue);">üìÖ Recent Activity</h3>
                            <div style="display: grid; gap: 0.75rem;">
                                ${data.recent_trades.slice(0, 10).map(trade => {
                                    const typeColor = trade.type === 'BUY' ? 'var(--accent-green)' : 'var(--accent-red)';
                                    return `
                                        <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px;">
                                            <span style="color: var(--text-primary); font-weight: 600;">${trade.ticker || 'N/A'}</span>
                                            <span style="color: ${typeColor}; font-weight: 600;">${trade.type}</span>
                                            <span style="color: var(--text-secondary);">${trade.date}</span>
                                            <span style="color: var(--text-primary);">${trade.amount ? formatCurrency(trade.amount) : 'N/A'}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;
            } catch (error) {
                console.error('Error loading insider profile:', error);
                content.innerHTML = `<div style="color: var(--accent-red);">Failed to load profile</div>`;
            }
        }

        function closeInsiderModal() {
            document.getElementById('insiderModal').style.display = 'none';
        }

        // Add to watchlist (placeholder)
        function addToWatchlist(ticker) {
            alert(`‚úÖ ${ticker} added to watchlist!\n(Feature coming soon)`);
        }

        // Export signals to CSV (using backend API)
        function exportSignalsToCSV() {
            const riskTolerance = document.getElementById('riskTolerance').value;
            const marketCap = document.getElementById('marketCap').value;
            const minConfidence = document.getElementById('minConfidence').value;
            const limit = document.getElementById('resultsLimit').value;
            
            const url = `/api/export/signals/csv?risk_tolerance=${riskTolerance}&market_cap=${marketCap}&min_confidence=${minConfidence}&limit=${limit}`;
            
            // Create temporary link and trigger download
            const a = document.createElement('a');
            a.href = url;
            a.download = '';  // Filename comes from server
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        // Export query results to CSV
        function exportTradesToCSV() {
            const ticker = document.getElementById('queryTicker').value;
            const startDate = document.getElementById('queryStartDate').value;
            const endDate = document.getElementById('queryEndDate').value;
            const minAmount = document.getElementById('queryMinAmount').value;
            const maxAmount = document.getElementById('queryMaxAmount').value;
            const txType = document.getElementById('queryTxType').value;
            const filerType = document.getElementById('queryFilerType').value;
            const limit = document.getElementById('queryLimit').value;
            
            const params = new URLSearchParams();
            if (ticker) params.append('ticker', ticker);
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (minAmount) params.append('min_amount', minAmount);
            if (maxAmount) params.append('max_amount', maxAmount);
            if (txType) params.append('transaction_type', txType);
            if (filerType) params.append('filer_type', filerType);
            params.append('limit', limit);
            
            const url = `/api/export/trades/csv?${params.toString()}`;
            
            // Create temporary link and trigger download
            const a = document.createElement('a');
            a.href = url;
            a.download = '';  // Filename comes from server
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        // Keep old function for backwards compatibility
        function exportToCSV() {
            exportSignalsToCSV();
        }

        // Auto-refresh
        function startAutoRefresh() {
            setInterval(() => {
                console.log('Auto-refreshing signals...');
                loadSignals();
            }, 60000); // Every minute
        }

        // Insider tooltip functions
        let tooltipTimeout = null;
        let insiderCache = {};

        async function showInsiderTooltip(event, name) {
            clearTimeout(tooltipTimeout);
            
            const tooltip = document.getElementById('insiderTooltip');
            const content = document.getElementById('tooltipContent');
            
            // Position tooltip near cursor
            tooltip.style.left = event.pageX + 15 + 'px';
            tooltip.style.top = event.pageY + 15 + 'px';
            tooltip.style.display = 'block';
            
            // Show loading state
            content.innerHTML = '<div style="color: var(--text-secondary);">Loading...</div>';
            
            // Fetch insider info (with caching)
            if (insiderCache[name]) {
                displayInsiderInfo(insiderCache[name]);
            } else {
                try {
                    const response = await fetch(`/api/insider_info/${encodeURIComponent(name)}`);
                    const data = await response.json();
                    
                    if (data.error) {
                        content.innerHTML = `<div style="color: var(--accent-red);">Info not available</div>`;
                    } else {
                        insiderCache[name] = data;
                        displayInsiderInfo(data);
                    }
                } catch (error) {
                    content.innerHTML = `<div style="color: var(--accent-red);">Failed to load</div>`;
                }
            }
        }

        function displayInsiderInfo(data) {
            const content = document.getElementById('tooltipContent');
            content.innerHTML = `
                <div style="font-weight: 600; font-size: 1rem; margin-bottom: 0.5rem; color: var(--text-primary);">
                    ${data.name}
                </div>
                <div style="color: var(--accent-blue); font-size: 0.875rem; margin-bottom: 0.75rem;">
                    ${data.role}
                </div>
                <div style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.5; margin-bottom: 0.75rem;">
                    ${data.significance}
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.8rem;">
                    <div>
                        <div style="color: var(--text-secondary);">Buy Trades</div>
                        <div style="color: var(--accent-green); font-weight: 600;">${data.buy_trades}</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary);">Sell Trades</div>
                        <div style="color: var(--accent-red); font-weight: 600;">${data.sell_trades}</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary);">Total Bought</div>
                        <div style="color: var(--text-primary); font-weight: 600;">${formatCurrency(data.total_bought)}</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary);">Unique Tickers</div>
                        <div style="color: var(--text-primary); font-weight: 600;">${data.unique_tickers}</div>
                    </div>
                </div>
                ${data.favorite_tickers && data.favorite_tickers.length > 0 ? `
                    <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color);">
                        <div style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 0.25rem;">FAVORITE TICKERS</div>
                        <div style="font-size: 0.85rem; color: var(--accent-blue);">${data.favorite_tickers.join(', ')}</div>
                    </div>
                ` : ''}
            `;
        }

        function hideInsiderTooltip() {
            tooltipTimeout = setTimeout(() => {
                document.getElementById('insiderTooltip').style.display = 'none';
            }, 200);
        }

        // Tab switching
        function showTab(tab) {
            const signalsTab = document.getElementById('signalsTab');
            const queryTab = document.getElementById('queryTab');
            const brokerTab = document.getElementById('brokerTab');
            const signalsContent = document.getElementById('signalsContent');
            const queryContent = document.getElementById('queryContent');
            const brokerContent = document.getElementById('brokerContent');

            // Reset all tabs
            [signalsTab, queryTab, brokerTab].forEach(t => t?.classList.remove('active'));
            [signalsContent, queryContent, brokerContent].forEach(c => c ? c.style.display = 'none' : null);

            if (tab === 'signals') {
                signalsTab.classList.add('active');
                signalsContent.style.display = 'block';
            } else if (tab === 'query') {
                queryTab.classList.add('active');
                queryContent.style.display = 'block';
                
                // Set default dates
                if (!document.getElementById('queryEndDate').value) {
                    const today = new Date().toISOString().split('T')[0];
                    const ninetyDaysAgo = new Date(Date.now() - 90*24*60*60*1000).toISOString().split('T')[0];
                    document.getElementById('queryEndDate').value = today;
                    document.getElementById('queryStartDate').value = ninetyDaysAgo;
                }
            } else if (tab === 'broker') {
                brokerTab.classList.add('active');
                brokerContent.style.display = 'block';
                loadBrokerStatus();
            }
        }

        // Query builder functions
        let queryResultsData = [];

        async function runCustomQuery() {
            const resultsDiv = document.getElementById('queryResults');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            const filters = {
                ticker: document.getElementById('queryTicker').value.toUpperCase() || null,
                start_date: document.getElementById('queryStartDate').value || null,
                end_date: document.getElementById('queryEndDate').value || null,
                min_amount: parseFloat(document.getElementById('queryMinAmount').value) || null,
                max_amount: parseFloat(document.getElementById('queryMaxAmount').value) || null,
                transaction_type: document.getElementById('queryTxType').value || null,
                filer_type: document.getElementById('queryFilerType').value || null,
                limit: parseInt(document.getElementById('queryLimit').value) || 100
            };

            // Remove null values
            Object.keys(filters).forEach(key => {
                if (filters[key] === null) delete filters[key];
            });

            try {
                const response = await fetch('/api/query/trades', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(filters)
                });
                const data = await response.json();

                queryResultsData = data.trades || [];

                if (queryResultsData.length === 0) {
                    resultsDiv.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üì≠</div>
                            <div class="empty-title">No results found</div>
                            <div class="empty-text">Try adjusting your filters</div>
                        </div>
                    `;
                    return;
                }

                // Render table
                let tableHTML = `
                    <div style="margin-bottom: 1rem; color: var(--text-primary);">
                        <strong>${data.count}</strong> trades found
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="query-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Ticker</th>
                                    <th>Insider</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Price</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                queryResultsData.forEach(trade => {
                    const typeColor = trade.type === 'BUY' ? 'var(--accent-green)' : 'var(--accent-red)';
                    tableHTML += `
                        <tr>
                            <td>${trade.date}</td>
                            <td style="font-weight: 600; color: var(--accent-blue);">${trade.ticker || 'N/A'}</td>
                            <td>${trade.insider || 'Unknown'}</td>
                            <td style="color: ${typeColor}; font-weight: 600;">${trade.type}</td>
                            <td>${trade.amount ? formatCurrency(trade.amount) : 'N/A'}</td>
                            <td>${trade.price ? '$' + trade.price.toFixed(2) : 'N/A'}</td>
                        </tr>
                    `;
                });

                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;

                resultsDiv.innerHTML = tableHTML;

            } catch (error) {
                console.error('Error running query:', error);
                resultsDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ö†Ô∏è</div>
                        <div class="empty-title">Error running query</div>
                        <div class="empty-text">${error.message}</div>
                    </div>
                `;
            }
        }

        function exportQueryResults() {
            if (queryResultsData.length === 0) {
                alert('No results to export. Run a query first.');
                return;
            }

            let csv = 'Date,Ticker,Insider,Type,Amount,Price\n';
            queryResultsData.forEach(trade => {
                csv += `${trade.date},${trade.ticker || 'N/A'},${trade.insider || 'Unknown'},${trade.type},"${formatCurrency(trade.amount || 0)}","${trade.price ? '$' + trade.price.toFixed(2) : 'N/A'}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trade-query-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function clearQueryFilters() {
            document.getElementById('queryTicker').value = '';
            document.getElementById('queryStartDate').value = '';
            document.getElementById('queryEndDate').value = '';
            document.getElementById('queryMinAmount').value = '';
            document.getElementById('queryMaxAmount').value = '';
            document.getElementById('queryTxType').value = '';
            document.getElementById('queryFilerType').value = '';
            document.getElementById('queryLimit').value = '100';
            document.getElementById('queryResults').innerHTML = `
                <div style="text-align: center; padding: 4rem 2rem; color: var(--text-secondary);">
                    Configure your filters and click "Run Query" to see results
                </div>
            `;
        }

        // Initialize
        // ========================================================================
        // BROKER FUNCTIONS
        // ========================================================================

        async function loadBrokerStatus() {
            const container = document.getElementById('brokerStatusCards');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch('/api/brokers/status');
                const data = await response.json();

                if (!data.brokers || data.brokers.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 2rem; text-align: center; color: var(--text-secondary); grid-column: 1/-1;">
                            ‚ö†Ô∏è No brokers configured. Add API keys to your .env file to get started.
                        </div>
                    `;
                    return;
                }

                container.innerHTML = data.brokers.map(broker => `
                    <div style="background: var(--bg-card); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border-color);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; text-transform: capitalize; color: var(--text-primary);">
                                    ${broker.name === 'schwab' ? 'üè¶ Schwab' : 'üíº E*TRADE'}
                                </h3>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="width: 8px; height: 8px; border-radius: 50%; background: ${broker.connected ? 'var(--success-color)' : 'var(--text-secondary)'}; display: inline-block;"></span>
                                    <span style="color: var(--text-secondary); font-size: 0.875rem;">
                                        ${broker.connected ? 'Connected' : 'Not Connected'}
                                    </span>
                                </div>
                            </div>
                            ${broker.active ? '<span style="background: var(--accent-color); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">ACTIVE</span>' : ''}
                        </div>

                        ${broker.connected && broker.account ? `
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                                <div style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.5rem;">Account Info:</div>
                                <div style="color: var(--text-primary);">
                                    ${broker.account.account_id || broker.account.accountId || 'Account Connected'}
                                </div>
                            </div>
                        ` : `
                            <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; color: var(--text-secondary); font-size: 0.875rem;">
                                OAuth authentication required. See setup instructions below.
                            </div>
                        `}

                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            ${!broker.active ? `
                                <button class="btn btn-secondary" style="flex: 1; font-size: 0.875rem; padding: 0.5rem;" onclick="setActiveBroker('${broker.name}')">
                                    Set Active
                                </button>
                            ` : ''}
                            ${broker.connected ? `
                                <button class="btn btn-primary" style="flex: 1; font-size: 0.875rem; padding: 0.5rem;" onclick="loadBrokerPositions('${broker.name}')">
                                    üìä View Positions
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading broker status:', error);
                container.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--error-color); grid-column: 1/-1;">
                        ‚ùå Error loading broker status: ${error.message}
                    </div>
                `;
            }
        }

        async function setActiveBroker(brokerName) {
            try {
                const response = await fetch('/api/brokers/set_active', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({broker: brokerName})
                });

                const result = await response.json();

                if (result.success) {
                    alert(`‚úÖ ${brokerName.toUpperCase()} is now the active broker`);
                    loadBrokerStatus();
                } else {
                    alert(`‚ùå Error: ${result.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error setting active broker: ${error.message}`);
            }
        }

        async function loadBrokerPositions(brokerName) {
            const positionsDiv = document.getElementById('brokerPositions');
            const tbody = document.getElementById('positionsTableBody');

            positionsDiv.style.display = 'block';
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">Loading positions...</td></tr>';

            try {
                const url = brokerName ? `/api/brokers/positions?broker=${brokerName}` : '/api/brokers/positions';
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--error-color);">${data.error}</td></tr>`;
                    return;
                }

                if (!data.positions || data.positions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-secondary);">No positions found</td></tr>';
                    return;
                }

                tbody.innerHTML = data.positions.map(pos => {
                    const returnPct = ((pos.current_price - pos.average_price) / pos.average_price * 100).toFixed(2);
                    const isProfit = returnPct >= 0;

                    return `
                        <tr>
                            <td><strong>${pos.symbol}</strong></td>
                            <td>${pos.quantity}</td>
                            <td>${formatCurrency(pos.average_price)}</td>
                            <td>${formatCurrency(pos.current_price)}</td>
                            <td>${formatCurrency(pos.market_value)}</td>
                            <td style="color: ${isProfit ? 'var(--success-color)' : 'var(--error-color)'}">
                                ${isProfit ? '+' : ''}${formatCurrency(pos.unrealized_pl)}
                            </td>
                            <td style="color: ${isProfit ? 'var(--success-color)' : 'var(--error-color)'}">
                                ${isProfit ? '+' : ''}${returnPct}%
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading positions:', error);
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--error-color);">Error: ${error.message}</td></tr>`;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadSignals();
            startAutoRefresh();

            // Add event listeners for filters
            document.getElementById('riskTolerance').addEventListener('change', loadSignals);
            document.getElementById('marketCap').addEventListener('change', loadSignals);
            document.getElementById('minConfidence').addEventListener('change', loadSignals);
            document.getElementById('resultsLimit').addEventListener('change', loadSignals);
        });
    </script>
</body>
</html>

